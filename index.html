
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QUINTUS ULTRA</title>
    <!-- Tailwind CSS CDN for development - for production, consider a build process -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: El Messiri -->
    <link href="https://fonts.googleapis.com/css2?family=El+Messiri:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Animate.css for animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <!-- GSAP for advanced animations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
    <!-- Ionicons for navigation icons -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import necessary Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getDatabase, ref, get, set, child, update, onValue } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        // --- Firebase Configuration (Hardcoded for direct access) ---
        // This configuration matches your admin panel and ensures the app can always connect.
        const firebaseConfig = {
            apiKey: "AIzaSyBL-oA4C7TPHxEBrW9QwxgNE9n8-uCEhRY",
            authDomain: "webut-83a0f.firebaseapp.com",
            databaseURL: "https://webut-83a0f-default-rtdb.firebaseio.com",
            projectId: "webut-83a0f",
            storageBucket: "webut-83a0f.appspot.com",
            messagingSenderId: "11308229615",
            appId: "1:11308229615:web:741af2dcfd77874bd74c1a",
            measurementId: "G-Y37GLFE8H7"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db; // Declare variables here to be accessible globally within this module script

        // Check if firebaseConfig and apiKey are valid before initializing Firebase
        if (firebaseConfig && firebaseConfig.apiKey) {
            // Initialize Firebase app
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getDatabase(app);

            // Export Firebase instances and functions to the global window object
            // This allows them to be accessed by the main script block (which is not a module)
            window.firebaseApp = app;
            window.firebaseAuth = auth;
            window.firebaseDb = db;
            
            window.dbRef = ref;
            window.dbGet = get;
            window.dbSet = set;
            window.dbChild = child;
            window.dbUpdate = update;
            window.dbOnValue = onValue;

            // --- System Status Check (Maintenance Mode / Web Off) ---
            // This listener checks for critical settings from Firebase Realtime Database
            // before proceeding with the main application or authentication.
            const settingsRef = ref(db, 'settings');
            onValue(settingsRef, (snapshot) => {
                const settings = snapshot.val();
                if (settings) {
                    if (settings.maintenanceMode) {
                        document.body.innerHTML = `<div style="text-align: center; padding: 50px; font-family: 'El Messiri', sans-serif; color: #C2185B; font-size: 24px;">Site is under maintenance. Please check back later.</div>`;
                        return; // Stop further execution if in maintenance mode
                    }
                    if (settings.webOff) {
                        if (settings.redirectUrl) {
                            window.location.replace(settings.redirectUrl); // Redirect if web is off and URL provided
                        } else {
                            document.body.innerHTML = `<div style="text-align: center; padding: 50px; font-family: 'El Messiri', sans-serif; color: #C2185B; font-size: 24px;">404 - Not Found</div>`;
                        }
                        return; // Stop further execution if web is off
                    }
                }
                // If no blocking settings, proceed with authentication setup
                setupFirebaseAuth();
            }, {
                onlyOnce: true // Only fetch these settings once on page load
            });

            // --- Firebase Authentication Setup ---
            // This function handles user authentication, either via a custom token or anonymously.
            async function setupFirebaseAuth() {
                try {
                    if (initialAuthToken) {
                        // Attempt to sign in with a custom token (provided by the environment)
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token.");
                    } else {
                        // If no custom token, sign in anonymously
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously.");
                    }

                    // After successful authentication, check local storage for login status
                    // and display either the main app or the login screen accordingly.
                    if (localStorage.getItem('isLoggedIn') === 'true') {
                        showMainApp();
                    } else {
                        showLogin();
                    }
                } catch (error) {
                    console.error("Firebase authentication error:", error);
                    const errorElement = document.getElementById('error');
                    if (errorElement) {
                        errorElement.innerText = "Authentication service failed. Please refresh.";
                        gsap.to('#error', { scale: 1, opacity: 1, duration: 0.5, ease: 'elastic.out(1, 0.6)' });
                    }
                }
            };
        } else {
            // If Firebase configuration or API key is missing, log an error and display a message.
            console.error("Firebase: Missing or invalid API key. Cannot initialize Firebase.");
            document.body.innerHTML = `<div style="text-align: center; padding: 50px; font-family: 'El Messiri', sans-serif; color: #D32F2F; font-size: 24px;">Application Error: Firebase not configured. Please contact support.</div>`;
        }
    </script>

    <style>
        /* Define CSS variables for consistent theming */
        :root {
            --primary: #87CEEB; /* Sky Blue - a soft, pleasant blue */
            --primary-light: #ADD8E6; /* Lighter Blue - for borders, subtle elements */
            --primary-dark: #4682B4; /* Steel Blue - for titles, icons, stronger accents */
            --secondary: #FFB6C1; /* Light Pink - for gradients, complementary accents */
            --white: #FFFFFF;
            --light-bg: #FDFDFD; /* Very subtle off-white for main background */
            --text-dark: #333333;
            --text-light: #666666;
        }

        /* Base body styles */
        body {
            font-family: 'El Messiri', sans-serif;
            background: linear-gradient(135deg, #FCE4EC, #E0FFFF); /* Original app background */
            min-height: 100vh;
            overflow-x: hidden; /* Prevent horizontal scrolling */
            position: relative;
            margin: 0;
            padding: 0;
            color: #C2185B; /* Original app text color */
            display: flex; /* Flexbox for centering content */
            align-items: center; /* Center vertically */
            justify-content: center; /* Center horizontally */
        }
        /* Specific body background for the login page */
        body.login-body {
            background: linear-gradient(135deg, #E0F2F7, #F8EAF0); /* Login page background */
        }

        /* Global text color reset for all elements */
        * {
            color: inherit; 
        }
        /* Specific text colors for login container elements */
        .login-container * {
            color: var(--text-dark); 
        }
        .login-container .title {
            -webkit-text-fill-color: unset; 
        }

        /* Popup and Modal base styles */
        .popup, .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Fixed position relative to viewport */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* Centering trick */
            background: rgba(224, 255, 255, 0.9); /* Semi-transparent background */
            padding: 1.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 6px 16px rgba(70, 130, 180, 0.3); /* Soft shadow */
            backdrop-filter: blur(8px); /* Frosted glass effect */
            z-index: 1000; /* High z-index to be on top */
            width: 90%;
            max-width: 400px;
            border: 2px solid #FFC0CB; /* Border color */
        }
        /* Active state for popups/modals */
        .popup.active, .modal.active {
            display: block;
        }

        /* Card component styling */
        .card {
            transition: all 0.3s ease; /* Smooth transitions for hover effects */
            background: rgba(224, 255, 255, 0.9);
            border-radius: 1.5rem;
            box-shadow: 0 6px 12px rgba(70, 130, 180, 0.2);
            backdrop-filter: blur(8px);
            position: relative;
            margin: 0.75rem;
            overflow: hidden;
        }
        /* Card hover effect */
        .card:hover {
            transform: translateY(-6px) scale(1.03);
            box-shadow: 0 8px 16px rgba(70, 130, 180, 0.3);
        }

        /* Gradient background utility class */
        .gradient-bg {
            background: linear-gradient(135deg, #4682B4, #E91E63);
        }

        /* SVG text animation for header */
        svg {
            width: 100%;
            height: auto;
            margin: 0 auto;
            display: block;
        }
        svg text {
            text-anchor: middle;
            dominant-baseline: middle;
            text-transform: uppercase;
            animation: stroke 5s infinite alternate; /* SVG stroke animation */
            stroke-width: 1.2;
            stroke: #4682B4;
            font-size: 10vw; /* Responsive font size */
            fill: rgba(224, 255, 255, 0); /* Transparent fill initially */
        }
        /* Media queries for SVG text font size */
        @media (min-width: 768px) {
            svg text {
                font-size: 8vw;
            }
        }
        @media (min-width: 1024px) {
            svg text {
                font-size: 6vw;
            }
        }
        /* Keyframes for SVG stroke animation */
        @keyframes stroke {
            0% { fill: rgba(224, 255, 255, 0); stroke: #4682B4; stroke-dashoffset: 25%; stroke-dasharray: 0 50%; stroke-width: 1.2; }
            70% { fill: rgba(224, 255, 255, 0); stroke: #E91E63; }
            80% { fill: rgba(224, 255, 255, 0); stroke: #FCE4EC; stroke-width: 2.5; }
            100% { fill: #FCE4EC; stroke: rgba(70, 130, 180, 0); stroke-dashoffset: -25%; stroke-dasharray: 50% 0; stroke-width: 0; }
        }

        /* History container and item styling */
        .history-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-height: none;
            overflow: visible;
            position: relative;
        }
        .history-item {
            transition: all 0.3s ease;
            width: 100%;
            max-width: 100%;
            margin: 0;
            border-radius: 1.2rem;
            background: rgba(224, 255, 255, 0.85);
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 14px rgba(70, 130, 180, 0.15);
            position: relative;
            overflow: hidden;
            padding: 1.2rem;
            border-left: 4px solid transparent; /* Left border for status indication */
        }
        /* Specific styles for pending and predicted history items */
        .history-item.pending { border-left-color: #FFC107; background: linear-gradient(135deg, rgba(255, 193, 7, 0.08), rgba(224, 255, 255, 0.85)); }
        .history-item.predicted { border-left-color: #4682B4; background: linear-gradient(135deg, rgba(70, 130, 180, 0.08), rgba(224, 255, 255, 0.85)); }
        /* History item hover and fade-out animations */
        .history-item:hover { transform: scale(1.02); box-shadow: 0 6px 18px rgba(70, 130, 180, 0.25); }
        .history-item.fade-out { animation: fadeOut 0.5s ease forwards; }
        @keyframes fadeOut {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.95); height: 0; padding: 0; margin: 0; }
        }

        /* Watermark for history items */
        .history-item .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 1.5rem;
            color: rgba(70, 130, 180, 0.15);
            pointer-events: none; /* Make it non-interactive */
            z-index: 0;
            text-transform: uppercase;
            font-weight: bold;
        }

        /* Small decorative dots animation */
        .small-dot {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #FFC0CB;
            border-radius: 50%;
            animation: float 4s infinite;
            z-index: 1;
        }
        @keyframes float {
            0% { transform: translate(0, 0); opacity: 0.9; }
            50% { transform: translate(12px, -12px); opacity: 0.5; }
            100% { transform: translate(0, 0); opacity: 0.9; }
        }

        /* Delete button hover effect */
        .delete-btn:hover { color: #4682B4; transform: scale(1.3); }

        /* Badge styling for pending and predicted states */
        .pending-badge { background: rgba(255, 193, 7, 0.15); color: #FF8F00; }
        .predicted-badge { background: rgba(70, 130, 180, 0.15); color: #4682B4; }

        /* Status icon styling */
        .status-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            position: relative;
            overflow: hidden;
        }
        /* Pseudo-element for radial gradient effect on status icons */
        .status-icon::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            opacity: 0.2;
            background: radial-gradient(circle, currentColor 0%, transparent 70%);
        }
        /* Specific animations for pending and predicted icons */
        .pending-icon { color: #FFC107; animation: rotate 2s infinite linear; }
        .predicted-icon { color: #4682B4; animation: pulseWin 1.5s infinite; }
        @keyframes pulseWin {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(70, 130, 180, 0.4); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(70, 130, 180, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(70, 130, 180, 0); }
        }
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Dashboard card styling */
        .dashboard-card {
            background: rgba(224, 255, 255, 0.9);
            border-radius: 1.5rem;
            padding: 1.2rem;
            box-shadow: 0 4px 10px rgba(70, 130, 180, 0.15);
            backdrop-filter: blur(8px);
            transition: all 0.3s ease;
        }
        /* Dashboard card hover effect */
        .dashboard-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 14px rgba(70, 130, 180, 0.25);
        }

        /* Confidence meter styling */
        .confidence-meter {
            height: 10px;
            background: #FCE4EC;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }
        .confidence-fill {
            height: 100%;
            background: #4682B4;
            transition: width 0.5s ease; /* Smooth width transition */
        }

        /* Bottom navigation bar styling */
        .navigation {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 350px;
            height: 70px;
            background: rgba(224, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 1.5rem;
            box-shadow: 0 6px 12px rgba(70, 130, 180, 0.3);
            z-index: 1000;
        }
        .navigation ul {
            display: flex;
            width: 300px;
        }
        .navigation ul li {
            position: relative;
            list-style: none;
            width: 75px;
            height: 70px;
            z-index: 1;
        }
        .navigation ul li a {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            width: 100%;
            text-align: center;
            font-weight: 500;
        }
        .navigation ul li a .icon {
            position: relative;
            display: block;
            line-height: 75px;
            font-size: 1.5em;
            text-align: center;
            transition: 0.5s;
        }
        .navigation ul li.active a .icon { transform: translateY(-32px); }
        .navigation ul li a .text {
            position: absolute;
            font-weight: 400;
            font-size: 0.75em;
            letter-spacing: 0.05em;
            transition: 0.5s;
            opacity: 0;
            transform: translateY(20px);
        }
        .navigation ul li.active a .text { opacity: 1; transform: translateY(10px); }

        /* Navigation indicator (the moving circle) */
        .indicator {
            position: absolute;
            top: -50%;
            width: 70px;
            height: 70px;
            background: #4682B4;
            border-radius: 50%;
            border: 6px solid #FCE4EC;
            transition: 0.5s;
        }
        /* Pseudo-elements for the indicator's "ears" */
        .indicator::before {
            content: '';
            position: absolute;
            top: 50%;
            left: -22px;
            width: 20px;
            height: 20px;
            background: transparent;
            border-top-right-radius: 20px;
            box-shadow: 1px -10px 0 0 #FCE4EC;
        }
        .indicator::after {
            content: '';
            position: absolute;
            top: 50%;
            right: -22px;
            width: 20px;
            height: 20px;
            background: transparent;
            border-top-left-radius: 20px;
            box-shadow: -1px -10px 0 0 #FCE4EC;
        }
        /* Indicator position based on active navigation item */
        .navigation ul li:nth-child(1).active ~ .indicator { transform: translateX(calc(75px * 0)); }
        .navigation ul li:nth-child(2).active ~ .indicator { transform: translateX(calc(75px * 1)); }
        .navigation ul li:nth-child(3).active ~ .indicator { transform: translateX(calc(75px * 2)); }
        .navigation ul li:nth-child(4).active ~ .indicator { transform: translateX(calc(75px * 3)); }

        /* Content section display toggle */
        .content-section { display: none; }
        .content-section.active { display: block; }

        /* Stats grid layout */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }

        /* Contact links styling */
        .contact-links {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }
        .contact-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            font-size: 12px;
        }
        .contact-link i {
            font-size: 20px;
            margin-bottom: 5px;
        }

        /* Period ID specific styling */
        .period-id {
            font-family: monospace;
            letter-spacing: 2px;
            font-size: 1.2rem;
        }
        /* Remove borders from specific elements */
        #currentPeriod, #currentResult {
            border: none !important;
        }

        /* Video container for responsive iframes */
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
            overflow: hidden;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* Button base styling */
        button, .btn {
            border-radius: 1rem;
            background: rgba(70, 130, 180, 0.9);
            backdrop-filter: blur(8px);
            transition: all 0.3s ease;
        }
        /* Button hover effect */
        button:hover, .btn:hover {
            background: #E91E63;
            transform: scale(1.05);
        }

        /* Loader animation styling */
        .loader {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100px;
            background: rgba(224, 255, 255, 0.5);
            padding: 20px;
            border-radius: 10px;
        }
        .loader-hourglass {
            width: 60px;
            height: 80px;
            background: #4682B4;
            clip-path: polygon(25% 0%, 75% 0%, 100% 25%, 75% 50%, 100% 75%, 25% 100%, 0% 75%, 25% 50%, 0% 25%);
            animation: rotate 2s linear infinite;
            position: relative;
        }
        .loader-hourglass::before {
            content: '';
            position: absolute;
            top: 20%;
            left: 20%;
            width: 60%;
            height: 60%;
            background: rgba(255, 255, 255, 0.2);
            clip-path: polygon(0% 0%, 100% 0%, 50% 100%);
            animation: sandFall 2s linear infinite;
        }
        .loader-text {
            font-size: 18px;
            font-family: 'El Messiri', sans-serif;
            color: #C2185B;
            text-align: center;
            margin-top: 10px;
            animation: pulse 1.5s ease-in-out infinite;
        }
        /* Keyframes for loader animations */
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes sandFall {
            0% { clip-path: polygon(0% 0%, 100% 0%, 50% 100%); }
            50% { clip-path: polygon(0% 50%, 100% 50%, 50% 100%); }
            100% { clip-path: polygon(0% 0%, 100% 0%, 50% 100%); }
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 480px) {
            .login-container {
                padding: 1.5rem;
            }

            .title {
                font-size: 1.4rem;
            }

            .last-key, .error-message, .success-message {
                font-size: 0.8rem;
            }

            .input-field {
                padding: 10px 15px 10px 40px;
                font-size: 0.9rem;
            }

            .submit-btn, .copy-btn {
                padding: 12px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div id="app-container" class="w-full h-full flex flex-col items-center justify-center">
        <!-- Login Section -->
        <div id="login-section" class="absolute inset-0 flex items-center justify-center p-4" style="display: none;">
            <!-- Decorative floating elements for background -->
            <div class="floating-element" style="width: 150px; height: 150px; top: 15%; left: 10%; background: radial-gradient(circle, var(--primary-light), transparent 70%);"></div>
            <div class="floating-element" style="width: 100px; height: 100px; bottom: 20%; right: 12%; background: radial-gradient(circle, var(--primary-light), transparent 70%);"></div>
            <div class="floating-element" style="width: 80px; height: 80px; top: 35%; right: 18%; background: radial-gradient(circle, var(--primary-light), transparent 70%);"></div>
            <div class="floating-element" style="width: 120px; height: 120px; bottom: 30%; left: 15%; background: radial-gradient(circle, var(--primary-light), transparent 70%);"></div>

            <div id="stars-container"></div>
            <div id="confetti-container"></div>

            <div class="login-container" id="loginContainer">
                <div class="logo-container">
                    <h1 class="title">QUINTUS ULTRA</h1>
                    <div class="error-message" id="error"></div>
                    <div class="success-message" id="success"></div>
                </div>

                <div class="input-group" id="inputGroup">
                    <i class="fas fa-key input-icon"></i>
                    <input type="text" id="accessKey" placeholder="Enter License Key" required class="input-field">
                </div>

                <div class="loading-message" id="loading">Loading...</div>

                <button class="submit-btn" id="submitBtn" onclick="handleLogin()">
                    <i class="fas fa-sign-in-alt mr-2"></i> Login
                </button>

                <div class="text-center mt-4">
                    <button class="copy-btn" id="copyBtn" onclick="copyDeviceId()">
                        <span class="copy-animation"></span>
                        <i class="fas fa-copy mr-2"></i>
                        <span id="copyText">Copy Device ID</span>
                    </button>
                </div>

                <div class="text-center mt-4">
                    <button class="copy-btn" onclick="getKey()">
                        <i class="fas fa-key mr-2"></i> Get Access Key
                    </button>
                </div>

                <div class="social-links" id="socialLinks">
                    <a href="https://t.me/TOJI_X_OWNER1" target="_blank" class="social-link" title="Telegram">
                        <i class="fab fa-telegram"></i>
                    </a>
                </div>
            </div>
        </div>

        <!-- Main App Section -->
        <div id="main-app-section" class="w-full relative pb-20" style="display: none;">
            <header class="text-center mt-0 mb-2 animate__animated animate__fadeInDown">
                <svg viewBox="0 0 800 120">
                    <text x="50%" y="50%">QUINTUS ULTRA</text>
                </svg>
            </header>

            <div class="max-w-full mx-auto p-2 w-full">
                <div class="max-w-4xl mx-auto p-2 w-full">
                    <!-- Home Section -->
                    <div id="homeSection" class="content-section active">
                        <div class="card mb-4 overflow-hidden gradient-bg animate__animated animate__zoomIn relative">
                            <div class="bg-white bg-opacity-95 p-6 rounded-lg pulse-animation">
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="relative">
                                        <div class="pl-2">
                                            <div class="flex items-center space-x-2 mb-2">
                                                <i class="fas fa-calendar-alt text-2xl animate__animated animate__bounce"></i>
                                                <h2 class="text-2xl font-bold" data-lang-key="period">Period</h2>
                                            </div>
                                            <p id="currentPeriod" class="text-2xl font-semibold bg-E91E63 p-3 rounded-lg shadow-inner period-id">-</p>
                                        </div>
                                    </div>
                                    <div class="relative text-right">
                                        <div class="flex items-center justify-end space-x-2 mb-2">
                                            <h2 class="text-2xl font-bold" data-lang-key="prediction">Prediction</h2>
                                            <i class="fas fa-poll text-2xl animate__animated animate__bounce"></i>
                                        </div>
                                        <p id="currentResult" class="text-2xl font-semibold bg-E91E63 p-3 rounded-lg shadow-inner">-</p>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <p class="text-sm" data-lang-key="confidence">Confidence</p>
                                    <div class="confidence-meter">
                                        <div id="confidenceFill" class="confidence-fill" style="width: 0%"></div>
                                    </div>
                                    <p id="confidenceText" class="text-sm mt-1">0%</p>
                                </div>
                            </div>
                            <!-- Small decorative dots for animation -->
                            <div class="small-dot" style="top: 15%; left: 15%; animation-delay: 0.2s;"></div>
                            <div class="small-dot" style="top: 85%; left: 85%; animation-delay: 0.8s;"></div>
                            <div class="small-dot" style="top: 50%; left: 25%; animation-delay: 1.2s;"></div>
                            <div class="small-dot" style="top: 20%; left: 80%; animation-delay: 1.6s;"></div>
                        </div>

                        <div class="card mb-4 p-6 animate__animated animate__fadeInUp relative">
                            <h2 class="text-3xl font-bold text-center mb-4 relative">
                                <span class="relative z-10 pulse-animation" data-lang-key="analysis_dashboard">Analysis Dashboard</span>
                                <span class="absolute top-1/2 left-0 w-full h-2 bg-E91E63 -translate-y-1/2 rounded-full"></span>
                            </h2>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <div class="dashboard-card animate__animated animate__fadeIn" style="animation-delay: 0s;">
                                    <div class="flex items-center space-x-2">
                                        <i class="fas fa-star text-lg"></i>
                                        <div>
                                            <p class="text-sm" data-lang-key="most_frequent">Most Frequent</p>
                                            <p id="mostFrequent" class="text-xl font-bold">-</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="dashboard-card animate__animated animate__fadeIn" style="animation-delay: 0.1s;">
                                    <div class="flex items-center space-x-2">
                                        <i class="fas fa-arrow-down text-lg"></i>
                                        <div>
                                            <p class="text-sm" data-lang-key="least_frequent">Least Frequent</p>
                                            <p id="leastFrequent" class="text-xl font-bold">-</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="dashboard-card animate__animated animate__fadeIn" style="animation-delay: 0.2s;">
                                    <div class="flex items-center space-x-2">
                                        <i class="fas fa-percentage text-lg"></i>
                                        <div>
                                            <p class="text-sm" data-lang-key="win_rate">Win Rate</p>
                                            <p id="winRate" class="text-xl font-bold">-</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="dashboard-card animate__animated animate__fadeIn" style="animation-delay: 0.3s;">
                                    <div class="flex items-center space-x-2">
                                        <i class="fas fa-trophy text-lg"></i>
                                        <div>
                                            <p class="text-sm" data-lang-key="wins">Wins</p>
                                            <p id="totalWinBets" class="text-xl font-bold">-</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="dashboard-card animate__animated animate__fadeIn" style="animation-delay: 0.4s;">
                                    <div class="flex items-center space-x-2">
                                        <i class="fas fa-skull text-lg"></i>
                                        <div>
                                            <p class="text-sm" data-lang-key="losses">Losses</p>
                                            <p id="totalLossBets" class="text-xl font-bold">-</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="dashboard-card flex items-center justify-between animate__animated animate__fadeIn" style="animation-delay: 0.5s;">
                                    <div class="flex items-center space-x-2">
                                        <i class="fas fa-server text-lg"></i>
                                        <div>
                                            <p class="text-sm" data-lang-key="server_status">Server Status</p>
                                            <p id="serverStatus" class="font-semibold" data-lang-key="connected">Connected</p>
                                        </div>
                                    </div>
                                    <div id="serverStatusIndicator" class="w-3 h-3 bg-4682B4 rounded-full animate-ping"></div>
                                </div>
                            </div>
                            <!-- Small decorative dots for animation -->
                            <div class="small-dot" style="top: 10%; left: 10%; animation-delay: 0.3s;"></div>
                            <div class="small-dot" style="top: 90%; left: 90%; animation-delay: 0.9s;"></div>
                            <div class="small-dot" style="top: 30%; left: 70%; animation-delay: 1.5s;"></div>
                        </div>
                    </div>

                    <!-- History Section -->
                    <div id="historySection" class="content-section">
                        <div class="card p-6 animate__animated animate__fadeInUp relative">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-3xl font-bold text-center relative">
                                    <span class="relative z-10 pulse-animation" data-lang-key="history">History</span>
                                    <span class="absolute top-1/2 left-0 w-full h-2 bg-E91E63 -translate-y-1/2 rounded-full"></span>
                                </h2>
                                <button id="deleteAllHistoryBtn" class="px-4 py-2 rounded-lg hover:bg-E91E63 transition flex items-center">
                                    <i class="fas fa-trash-alt mr-2"></i><span data-lang-key="delete">Delete</span>
                                </button>
                            </div>
                            <div id="history" class="history-container"></div>
                            <!-- Small decorative dots for animation -->
                            <div class="small-dot" style="top: 20%; left: 30%; animation-delay: 0.4s;"></div>
                            <div class="small-dot" style="top: 80%; left: 70%; animation-delay: 0.9s;"></div>
                            <div class="small-dot" style="top: 40%; left: 50%; animation-delay: 1.3s;"></div>
                        </div>
                    </div>

                    <!-- Stats Section -->
                    <div id="statsSection" class="content-section">
                        <div class="card p-6 animate__animated animate__fadeInUp relative">
                            <h2 class="text-3xl font-bold text-center mb-4 relative">
                                <span class="relative z-10 pulse-animation" data-lang-key="statistics">Statistics</span>
                                <span class="absolute top-1/2 left-0 w-full h-2 bg-E91E63 -translate-y-1/2 rounded-full"></span>
                            </h2>
                            <div class="stats-grid">
                                <div class="dashboard-card">
                                    <div class="flex items-center space-x-2">
                                        <i class="fas fa-trophy text-green-500 text-lg"></i>
                                        <div>
                                            <p class="text-sm" data-lang-key="total_wins">Total Wins</p>
                                            <p id="statsTotalWins" class="text-xl font-bold">-</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="dashboard-card">
                                    <div class="flex items-center space-x-2">
                                        <i class="fas fa-skull text-red-500 text-lg"></i>
                                        <div>
                                            <p class="text-sm" data-lang-key="total_losses">Total Losses</p>
                                            <p id="statsTotalLosses" class="text-xl font-bold">-</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="dashboard-card">
                                    <div class="flex items-center space-x-2">
                                        <i class="fas fa-percentage text-yellow-500 text-lg"></i>
                                        <div>
                                            <p class="text-sm" data-lang-key="win_rate">Win Rate</p>
                                            <p id="statsWinRate" class="text-xl font-bold">-</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="dashboard-card">
                                    <div class="flex items-center space-x-2">
                                        <i class="fas fa-fire text-orange-500 text-lg"></i>
                                        <div>
                                            <p class="text-sm" data-lang-key="current_streak">Current Streak</p>
                                            <p id="currentStreak" class="text-xl font-bold">-</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="dashboard-card">
                                    <div class="flex items-center space-x-2">
                                        <i class="fas fa-history text-blue-500 text-lg"></i>
                                        <div>
                                            <p class="text-sm" data-lang-key="last_five_results">Last 5 Results</p>
                                            <p id="lastFiveResults" class="text-xl font-bold">-</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Small decorative dots for animation -->
                            <div class="small-dot" style="top: 15%; left: 20%; animation-delay: 0.5s;"></div>
                            <div class="small-dot" style="top: 85%; left: 80%; animation-delay: 1s;"></div>
                        </div>
                    </div>

                    <!-- About Section -->
                    <div id="aboutSection" class="content-section">
                        <div class="card p-6 animate__animated animate__fadeInUp relative">
                            <h2 class="text-3xl font-bold text-center mb-4 relative">
                                <span class="relative z-10 pulse-animation" data-lang-key="about_us">About Us</span>
                                <span class="absolute top-1/2 left-0 w-full h-2 bg-E91E63 -translate-y-1/2 rounded-full"></span>
                            </h2>
                            <div class="flex flex-col gap-4">
                                <div class="dashboard-card">
                                    <h3 class="text-xl font-semibold mb-2" data-lang-key="ai_features_title">AI Features</h3>
                                    <ul class="list-disc list-inside text-sm space-y-1">
                                        <li data-lang-key="feature_realtime">Real-time Prediction Analysis</li>
                                        <li data-lang-key="feature_confidence">Advanced Confidence Scoring</li>
                                        <li data-lang-key="feature_history_analysis">Comprehensive Historical Data Analysis</li>
                                        <li data-lang-key="feature_trend_detection">Intelligent Trend Detection</li>
                                        <li data-lang-key="feature_notifications">Instant Prediction Notifications</li>
                                    </ul>
                                </div>
                                <div class="dashboard-card">
                                    <h3 class="text-xl font-semibold mb-2" data-lang-key="owner_info_title">Owner Information</h3>
                                    <p class="text-sm">
                                        <span data-lang-key="owner_name">Owner:</span> TOJI X OWNER1
                                    </p>
                                    <p class="text-sm flex items-center space-x-2 mt-1">
                                        <i class="fab fa-telegram text-lg"></i>
                                        <a href="https://t.me/TOJI_X_OWNER1" target="_blank" class="hover:underline text-4682B4">@TOJI_X_OWNER1</a>
                                    </p>
                                </div>
                                <div class="dashboard-card">
                                    <h3 class="text-xl font-semibold mb-2" data-lang-key="disclaimer_title">Disclaimer</h3>
                                    <p class="text-xs" data-lang-key="disclaimer_text">
                                        QUINTUS ULTRA provides predictions for informational and entertainment purposes only. We do not guarantee the accuracy of any predictions and strongly advise against making financial decisions based solely on the information provided. Users are solely responsible for their actions. This application is not intended as financial advice.
                                    </p>
                                </div>
                            </div>
                            <!-- Small decorative dots for animation -->
                            <div class="small-dot" style="top: 10%; left: 15%; animation-delay: 0.6s;"></div>
                            <div class="small-dot" style="top: 90%; left: 85%; animation-delay: 1.1s;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Bar -->
            <div class="navigation">
                <ul>
                    <li class="active">
                        <a href="#" data-section="homeSection">
                            <span class="icon"><ion-icon name="home-outline"></ion-icon></span>
                            <span class="text" data-lang-key="home">Home</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="historySection">
                            <span class="icon"><ion-icon name="time-outline"></ion-icon></span>
                            <span class="text" data-lang-key="history">History</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="statsSection">
                            <span class="icon"><ion-icon name="bar-chart-outline"></ion-icon></span>
                            <span class="text" data-lang-key="stats">Stats</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="aboutSection">
                            <span class="icon"><ion-icon name="information-circle-outline"></ion-icon></span>
                            <span class="text" data-lang-key="about">About</span>
                        </a>
                    </li>
                    <div class="indicator"></div>
                </ul>
            </div>

            <!-- Video Popup -->
            <div id="videoPopup" class="popup">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold" data-lang-key="how_to_use_newro_x">How To Use QUINTUS ULTRA</h3>
                    <button onclick="closeVideoPopup()" class="hover:text-4682B4">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="video-container">
                    <!-- Placeholder YouTube video. Replace with actual video if available. -->
                    <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" frameborder="0" allowfullscreen></iframe>
                </div>
            </div>

            <!-- Confirmation Modal -->
            <div id="confirmModal" class="modal">
                <h3 class="text-lg font-semibold mb-4" data-lang-key="confirm_action">Confirm Action</h3>
                <p id="modalMessage" class="mb-4"></p>
                <div class="flex justify-end space-x-2">
                    <button id="cancelModalBtn" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition" data-lang-key="cancel">Cancel</button>
                    <button id="confirmModalBtn" class="px-4 py-2 rounded-lg hover:bg-E91E63 transition" data-lang-key="confirm">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // NOTE: Errors like "Cannot find menu item with id translate-page" are often caused by
        // browser extensions (e.g., Google Translate) and not by the application code itself.
        // If you see such errors, try disabling browser extensions.

        // --- UI Display Logic for Login vs. Main App ---
        const loginSection = document.getElementById('login-section');
        const mainAppSection = document.getElementById('main-app-section');
        const body = document.body;

        // Function to show the login section with animations
        function showLogin() {
            mainAppSection.style.display = 'none';
            loginSection.style.display = 'flex';
            body.classList.add('login-body'); // Apply login-specific background
            // GSAP animations for login page elements
            gsap.to('#loginContainer', {
                opacity: 1,
                visibility: 'visible',
                y: 0,
                duration: 0.7,
                ease: 'power3.out',
                onComplete: () => {
                    document.getElementById('loginContainer').classList.add('visible');
                }
            });
            gsap.to('.logo-container', { scale: 1, opacity: 1, duration: 0.6, delay: 0.15, ease: 'elastic.out(1, 0.6)' });
            gsap.to('#inputGroup', { x: 0, opacity: 1, duration: 0.5, delay: 0.3, ease: 'power2.out' });
            gsap.to('#submitBtn', { y: 0, opacity: 1, duration: 0.5, delay: 0.6, ease: 'power2.out' });
            gsap.to('#copyBtn', { y: 0, opacity: 1, duration: 0.5, delay: 0.75, ease: 'power2.out' });
            gsap.to('#socialLinks', {
                y: 0, opacity: 1, duration: 0.5, delay: 0.9, ease: 'power2.out', onComplete: () => {
                    gsap.to('.social-link', { y: -8, duration: 0.4, stagger: 0.08, repeat: -1, yoyo: true, ease: 'sine.inOut' });
                }
            });
            gsap.to('.floating-element', { y: 15, rotation: 3, duration: 4, repeat: -1, yoyo: true, ease: 'sine.inOut', stagger: 0.2 });
        }

        // Function to show the main application section
        function showMainApp() {
            loginSection.style.display = 'none';
            mainAppSection.style.display = 'block';
            body.classList.remove('login-body'); // Remove login-specific background
            initializeApp(); // Initialize main app logic once visible
        }

        // --- Login Page Specific Functions ---

        // Generates and retrieves a unique device ID, storing it in local storage
        function getDeviceId() {
            let id = localStorage.getItem("device_id");
            if (!id) {
                // Use crypto.randomUUID for better uniqueness if available
                if (crypto.randomUUID) {
                    id = crypto.randomUUID();
                } else {
                    // Fallback for older browsers
                    id = 'id-' + Math.random().toString(36).substr(2, 9) + '-' + Date.now();
                }
                localStorage.setItem("device_id", id);
            }
            return id;
        }
        
        // Displays messages (error or success) on the login form with animations
        function showLoginMessage(type, message) {
            const errorDiv = document.getElementById("error");
            const successDiv = document.getElementById("success");
            const targetDiv = type === 'error' ? errorDiv : successDiv;
            const otherDiv = type === 'error' ? successDiv : errorDiv;

            otherDiv.innerText = "";
            gsap.to(otherDiv, { opacity: 0, scale: 0.95, duration: 0.3 }); // Fade out other message
            
            targetDiv.innerText = message;
            gsap.to(targetDiv, { scale: 1, opacity: 1, duration: 0.5, ease: 'elastic.out(1, 0.6)' }); // Animate target message in
        }

        // --- SECURE LOGIN HANDLER ---
        // Validates the entered access key against the Firebase Realtime Database
        window.handleLogin = async function () {
            const key = document.getElementById("accessKey").value.trim();
            const deviceId = getDeviceId();
            const loadingDiv = document.getElementById("loading");
            const submitBtn = document.getElementById('submitBtn');
            const MAX_ATTEMPTS = 3; // Maximum allowed login attempts

            if (!key) {
                showLoginMessage('error', "Please enter an access key.");
                return;
            }

            loadingDiv.style.display = 'block'; // Show loading indicator
            submitBtn.disabled = true; // Disable submit button during login process

            try {
                // 1. Check if device is banned due to too many failed attempts
                const bannedRef = window.dbChild(window.dbRef(window.firebaseDb), `bannedDevices/${deviceId}`);
                const bannedSnapshot = await window.dbGet(bannedRef);
                if (bannedSnapshot.exists()) {
                    showLoginMessage('error', "This device has been banned due to multiple failed login attempts.");
                    loadingDiv.style.display = 'none';
                    submitBtn.disabled = false;
                    return;
                }

                // 2. Retrieve current login attempts for this device
                const attemptsRef = window.dbChild(window.dbRef(window.firebaseDb), `loginAttempts/${deviceId}`);
                const attemptsSnapshot = await window.dbGet(attemptsRef);
                let currentAttempts = attemptsSnapshot.val() || 0;

                // If attempts exceed limit, ban the device
                if (currentAttempts >= MAX_ATTEMPTS) {
                    await window.dbSet(bannedRef, true); // Ban the device
                    showLoginMessage('error', "This device has been banned. Please contact support.");
                    loadingDiv.style.display = 'none';
                    submitBtn.disabled = false;
                    return;
                }

                // 3. Validate the entered key against the 'accessKeys' node in Firebase
                const keyRef = window.dbChild(window.dbRef(window.firebaseDb), `accessKeys/${key}`);
                const keySnapshot = await window.dbGet(keyRef);

                if (!keySnapshot.exists()) {
                    // Key not found, increment attempts
                    currentAttempts++;
                    await window.dbSet(attemptsRef, currentAttempts);
                    showLoginMessage('error', `Invalid key. You have ${MAX_ATTEMPTS - currentAttempts} attempts left.`);
                } else {
                    const keyData = keySnapshot.val();
                    // Check if the key is associated with this device
                    if (keyData.deviceId !== deviceId) {
                        currentAttempts++;
                        await window.dbSet(attemptsRef, currentAttempts);
                        showLoginMessage('error', `This key is not for this device. ${MAX_ATTEMPTS - currentAttempts} attempts left.`);
                    } else if (keyData.active === false) {
                        // Check if the key is deactivated
                        showLoginMessage('error', "This key has been deactivated.");
                    } else if (keyData.expiry < Date.now()) {
                        // Check if the key has expired
                        showLoginMessage('error', "This key has expired.");
                    } else {
                        // Login SUCCESS!
                        await window.dbSet(attemptsRef, 0); // Reset attempts on successful login
                        showLoginMessage('success', "Login Successful! Loading app...");
                        localStorage.setItem('isLoggedIn', 'true'); // Store login status
                        setTimeout(() => {
                            showMainApp(); // Transition to main app after a delay
                        }, 1500);
                        return; // Exit function on success
                    }
                }
            } catch (error) {
                console.error("Login validation error:", error);
                showLoginMessage('error', "An error occurred. Please try again.");
            }
            
            // This part only executes if the login process failed
            loadingDiv.style.display = 'none';
            submitBtn.disabled = false;
        };

        // Opens Telegram chat to request an access key
        window.getKey = function () {
            const message = encodeURIComponent("HELLO @TOJI_X_OWNER1, I NEED AN ACCESS KEY.");
            window.open(`https://t.me/TOJI_X_OWNER1?text=${message}`, '_blank');
        };

        // Copies the device ID to the clipboard and provides visual feedback
        function copyDeviceId() {
            const deviceId = getDeviceId();
            // Use document.execCommand for clipboard operations due to iframe restrictions
            if (document.execCommand) { 
                const tempInput = document.createElement('textarea');
                tempInput.value = deviceId;
                document.body.appendChild(tempInput);
                tempInput.select();
                try {
                    document.execCommand('copy');
                    const copyBtn = document.getElementById('copyBtn');
                    const copyText = document.getElementById('copyText');

                    createConfetti(); // Create confetti elements
                    animateConfetti(); // Animate confetti

                    copyBtn.classList.add('copied');
                    copyText.innerHTML = 'Copied!';

                    // GSAP animation for the copy button feedback
                    gsap.to(copyBtn, {
                        scale: 1.08,
                        duration: 0.15,
                        yoyo: true,
                        repeat: 1,
                        ease: 'power2.inOut',
                        onComplete: () => {
                            setTimeout(() => {
                                copyBtn.classList.remove('copied');
                                copyText.innerHTML = 'Copy Device ID';
                            }, 1200); // Reset text after a delay
                        }
                    });
                } catch (err) {
                    console.error('Failed to copy: ', err);
                } finally {
                    document.body.removeChild(tempInput); // Clean up temporary textarea
                }
            }
        }

        // Creates floating star elements for the background animation on the login page
        function createStars() {
            const container = document.getElementById('stars-container');
            if (!container) return; // Exit if container not found
            container.innerHTML = ''; // Clear existing stars
            const starCount = 40; // Number of stars to create

            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.classList.add('star');

                const size = Math.random() * 2 + 1; // Random size for stars
                const posX = Math.random() * 100; // Random X position
                const posY = Math.random() * 100; // Random Y position
                const duration = Math.random() * 4 + 2 + 's'; // Random animation duration
                const delay = Math.random() * 4 + 's'; // Random animation delay

                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.left = `${posX}%`;
                star.style.top = `${posY}%`;
                star.style.setProperty('--duration', duration); // Set CSS variable for animation duration
                star.style.animationDelay = delay;

                container.appendChild(star);
            }
        }

        // Creates confetti elements for the copy animation
        function createConfetti() {
            const container = document.getElementById('confetti-container');
            if (!container) return; // Exit if container not found
            container.innerHTML = ''; // Clear existing confetti
            const confettiCount = 80; // Number of confetti pieces

            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');

                const size = Math.random() * 8 + 4; // Random size
                const posX = Math.random() * window.innerWidth; // Random X position within window width
                const posY = -20; // Start above the viewport
                const color = `hsl(${Math.random() * 180 + 180}, 80%, 70%)`; // Random color
                const rotation = Math.random() * 360; // Random initial rotation
                const shape = Math.random() > 0.5 ? '50%' : '0'; // Random shape (circle or square)

                confetti.style.width = `${size}px`;
                confetti.style.height = `${size}px`;
                confetti.style.left = `${posX}px`;
                confetti.style.top = `${posY}px`;
                confetti.style.backgroundColor = color;
                confetti.style.borderRadius = shape;
                confetti.style.transform = `rotate(${rotation}deg)`;

                container.appendChild(confetti);
            }
        }

        // Animates the created confetti elements to fall and fade out
        function animateConfetti() {
            const confetti = document.querySelectorAll('.confetti');

            confetti.forEach((piece, index) => {
                const duration = Math.random() * 2.5 + 1.5; // Random duration for each piece
                const delay = index * 0.015; // Staggered delay

                gsap.to(piece, {
                    y: window.innerHeight + 80, // Fall below the viewport
                    x: `+=${Math.random() * 150 - 75}`, // Random horizontal movement
                    rotation: Math.random() * 360, // Random rotation during fall
                    opacity: 1,
                    duration: duration,
                    delay: delay,
                    ease: 'power1.out',
                    onComplete: () => {
                        piece.remove(); // Remove confetti element after animation
                    }
                });
            });
        }

        // Event listeners for login page elements to add interactive animations
        document.addEventListener('DOMContentLoaded', () => {
            const licenseInput = document.getElementById('accessKey');
            const submitBtn = document.getElementById('submitBtn');

            if (licenseInput) {
                licenseInput.addEventListener('focus', () => {
                    gsap.to('.input-icon', { scale: 1.1, duration: 0.25, ease: 'back.out' });
                });
                licenseInput.addEventListener('blur', () => {
                    gsap.to('.input-icon', { scale: 1, duration: 0.25, ease: 'back.out' });
                });
            }

            if (submitBtn) {
                submitBtn.addEventListener('mouseenter', () => {
                    gsap.to(submitBtn, { y: -2, duration: 0.25, ease: 'power2.out' });
                });
                submitBtn.addEventListener('mouseleave', () => {
                    gsap.to(submitBtn, { y: 0, duration: 0.25, ease: 'power2.out' });
                });
            }
            createStars(); // Initialize background stars on page load
        });


        // --- Main App Specific Logic ---

        // Multilingual translations for various UI elements
        const translations = {
            en: {
                period: "Period",
                prediction: "Prediction",
                confidence: "Confidence",
                analysis_dashboard: "Analysis Dashboard",
                most_frequent: "Most Frequent",
                least_frequent: "Least Frequent",
                win_rate: "Win Rate",
                wins: "Wins",
                losses: "Losses",
                server_status: "Server Status",
                connected: "Connected",
                disconnected: "Disconnected",
                history: "History",
                delete: "Delete",
                statistics: "Statistics",
                total_wins: "Total Wins",
                total_losses: "Total Losses",
                current_streak: "Current Streak",
                last_five_results: "Last 5 Results",
                about: "About",
                about_us: "About Us",
                ai_features_title: "AI Features",
                feature_realtime: "Real-time Prediction Analysis",
                feature_confidence: "Advanced Confidence Scoring",
                feature_history_analysis: "Comprehensive Historical Data Analysis",
                feature_trend_detection: "Intelligent Trend Detection",
                feature_notifications: "Instant Prediction Notifications",
                owner_info_title: "Owner Information",
                owner_name: "Owner:",
                disclaimer_title: "Disclaimer",
                disclaimer_text: "QUINTUS ULTRA provides predictions for informational and entertainment purposes only. We do not guarantee the accuracy of any predictions and strongly advise against making financial decisions based solely on the information provided. Users are solely responsible for their actions. This application is not intended as financial advice.",
                how_to_use_newro_x: "How To Use QUINTUS ULTRA",
                confirm_action: "Confirm Action",
                cancel: "Cancel",
                confirm: "Confirm",
                pending: "Pending",
                delete_item_confirm: "Are you sure you want to delete this history item?",
                delete_all_confirm: "Are you sure you want to delete all history items?",
                reset_settings_confirm: "Are you sure you want to reset all settings to default?"
            },
            hi: {
                period: "अवधि",
                prediction: "भविष्यवाणी",
                confidence: "आत्मविश्वास",
                analysis_dashboard: "विश्लेषण डैशबोर्ड",
                most_frequent: "सबसे अधिक बार",
                least_frequent: "सबसे कम बार",
                win_rate: "जीत की दर",
                wins: "जीत",
                losses: "हानि",
                server_status: "सर्वर स्थिति",
                connected: "जुड़ा हुआ",
                disconnected: "डिस्कनेक्ट किया गया",
                history: "इतिहास",
                delete: "हटाएं",
                statistics: "आंकड़े",
                total_wins: "कुल जीत",
                total_losses: "कुल हानि",
                current_streak: "वर्तमान लकीर",
                last_five_results: "अंतिम 5 परिणाम",
                about: "के बारे में",
                about_us: "हमारे बारे में",
                ai_features_title: "एआई विशेषताएँ",
                feature_realtime: "वास्तविक समय भविष्यवाणी विश्लेषण",
                feature_confidence: "उन्नत आत्मविश्वास स्कोरिंग",
                feature_history_analysis: "व्यापक ऐतिहासिक डेटा विश्लेषण",
                feature_trend_detection: "बुद्धिमान प्रवृत्ति का पता लगाना",
                feature_notifications: "तत्काल भविष्यवाणी सूचनाएं",
                owner_info_title: "मालिक की जानकारी",
                owner_name: "मालिक:",
                disclaimer_title: "अस्वीकरण",
                disclaimer_text: "क्विंटस अल्ट्रा केवल सूचनात्मक और मनोरंजक उद्देश्यों के लिए भविष्यवाणियां प्रदान करता है। हम किसी भी भविष्यवाणी की सटीकता की गारंटी नहीं देते हैं और केवल प्रदान की गई जानकारी के आधार पर वित्तीय निर्णय लेने के खिलाफ दृढ़ता से सलाह देते हैं। उपयोगकर्ता अपने कार्यों के लिए पूरी तरह से जिम्मेदार हैं। यह एप्लिकेशन वित्तीय सलाह के रूप में अभिप्रेत नहीं है।",
                how_to_use_newro_x: "क्विंटस अल्ट्रा का उपयोग कैसे करें",
                confirm_action: "कार्रवाई की पुष्टि करें",
                cancel: "रद्द करें",
                confirm: "पुष्टि करें",
                pending: "लंबित",
                delete_item_confirm: "क्या आप इस इतिहास आइटम को हटाना चाहते हैं?",
                delete_all_confirm: "क्या आप सभी इतिहास आइटम को हटाना चाहते हैं?",
                reset_settings_confirm: "क्या आप सभी सेटिंग्स को डिफ़ॉल्ट पर रीसेट करना चाहते हैं?"
            }
        };

        // Application state variables, initialized from local storage or defaults
        let currentLanguage = localStorage.getItem('language') || 'en';
        let isSoundEnabled = localStorage.getItem('sound') === 'true' || true; // Default to true if not set
        let isNotificationsEnabled = localStorage.getItem('notifications') === 'true' || false; // Default to false

        // Centralized state object for managing application data
        const state = {
            lastPeriodNumber: null, // Stores the last known period number
            history: [], // Array to store prediction history
            currentResult: null, // Stores the current prediction result
            pendingResult: null, // Not currently used, but kept for potential future use
            stats: { winCount: 0, lossStreak: 0, totalBets: 0, totalWins: 0, totalLosses: 0 }, // Statistics
            isResultProcessing: false, // Flag to prevent multiple prediction generations
            cachedData: [], // Cache for API data
            lastResults: { bigsmall: [] }, // Stores last 5 big/small results
            currentPrediction: null, // Stores the current prediction and its confidence
            currentPeriod: null // Stores the current period being predicted for
        };

        // Updates the language of all elements with a 'data-lang-key' attribute
        function updateLanguage() {
            document.querySelectorAll('[data-lang-key]').forEach(element => {
                const key = element.getAttribute('data-lang-key');
                element.textContent = translations[currentLanguage][key] || element.textContent;
            });
        }

        // Navigation logic for switching between sections
        const navItems = document.querySelectorAll('.navigation ul li');
        const sections = document.querySelectorAll('.content-section');

        navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault(); // Prevent default link behavior
                // Remove 'active' class from all navigation items and sections
                navItems.forEach(nav => nav.classList.remove('active'));
                sections.forEach(section => section.classList.add('hidden')); // Ensure all are hidden first
                
                // Add 'active' class to the clicked navigation item and its corresponding section
                item.classList.add('active');
                const sectionId = item.querySelector('a').getAttribute('data-section');
                document.getElementById(sectionId).classList.remove('hidden'); // Show only the active section

                // Animate the navigation indicator
                const index = Array.from(navItems).indexOf(item);
                const itemWidth = window.innerWidth <= 768 ? 62.5 : 75; // Adjust width based on screen size
                document.querySelector('.indicator').style.transform = `translateX(calc(${itemWidth}px * ${index}))`;

                updatePredictionDisplay(); // Update display after section change
            });
        });

        // Functions to open and close the video popup
        function openVideoPopup() {
            document.getElementById('videoPopup').classList.add('active');
            if (isSoundEnabled) {
                new Audio('https://www.soundjay.com/buttons/beep-01a.mp3').play();
            }
        }

        function closeVideoPopup() {
            document.getElementById('videoPopup').classList.remove('active');
            if (isSoundEnabled) {
                new Audio('https://www.soundjay.com/buttons/beep-02.mp3').play();
            }
        }

        // Displays a confirmation modal with a message and a callback for confirmation
        function showConfirmModal(message, onConfirm) {
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('confirmModal').classList.add('active');
            const confirmBtn = document.getElementById('confirmModalBtn');
            const cancelBtn = document.getElementById('cancelModalBtn');

            // Event listener for the confirm button
            const confirmHandler = () => {
                onConfirm(); // Execute the provided callback function
                document.getElementById('confirmModal').classList.remove('active'); // Hide modal
                confirmBtn.removeEventListener('click', confirmHandler); // Remove listener to prevent multiple calls
                if (isSoundEnabled) {
                    new Audio('https://www.soundjay.com/buttons/beep-01a.mp3').play();
                }
            };

            confirmBtn.addEventListener('click', confirmHandler);
            // Event listener for the cancel button
            cancelBtn.addEventListener('click', () => {
                document.getElementById('confirmModal').classList.remove('active'); // Hide modal
                if (isSoundEnabled) {
                    new Audio('https://www.soundjay.com/buttons/beep-02.mp3').play();
                }
            });
        }

        // API caching mechanism to reduce redundant fetches
        const apiCache = new Map();
        const CACHE_DURATION = 30000; // Cache duration in milliseconds (30 seconds)

        // Fetches optimized data from the API, prioritizing cached data
        async function fetchOptimizedData(maxPages = 2) { 
            const cacheKey = 'optimized-data';
            const cached = apiCache.get(cacheKey);
            // If cached data exists, is fresh, and has enough entries, return it
            if (cached && Date.now() - cached.timestamp < CACHE_DURATION && cached.data.length >= 20) { 
                return cached.data.slice(0, 20); // Return only the first 20 for consistency
            }
            try {
                // Fetch multiple pages concurrently
                const promises = Array.from({length: maxPages}, (_, i) => fetchOptimizedPage(i + 1));
                const results = await Promise.allSettled(promises); // Wait for all promises to settle
                const allData = results
                    .filter(result => result.status === 'fulfilled') // Filter out rejected promises
                    .flatMap(result => result.value); // Flatten the array of arrays
                state.cachedData = allData; // Update global cached data
                apiCache.set(cacheKey, { data: allData, timestamp: Date.now() }); // Store in cache
                return allData.slice(0, 20); // Return first 20 entries
            } catch (error) {
                console.error('Error fetching optimized data:', error);
                updateServerStatus(false); // Indicate server disconnection
                return state.cachedData.slice(0, 20) || []; // Return existing cached data or empty array
            }
        }

        // Fetches a single page of data from the external API
        async function fetchOptimizedPage(page) {
            const cacheKey = `page-${page}`;
            const cached = apiCache.get(cacheKey);
            // If page is already cached and fresh, return it
            if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
                return cached.data;
            }
            try {
                const controller = new AbortController();
                // Set a timeout for the fetch request
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 seconds timeout
                const response = await fetch("https://ckyjgfr.com/api/webapi/GetNoaverageEmerdList", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Cache-Control": "no-cache" },
                    body: JSON.stringify({
                        pageSize: 10,
                        pageNo: page,
                        typeId: 1,
                        language: 0,
                        random: "fcc5f4ef6583416ab2439096e1c67c62", // These might be static or dynamic, verify if needed
                        signature: "B24ACE2541B8C543DF6F20ACEE7E3EBE", // These might be static or dynamic, verify if needed
                        timestamp: Math.floor(Date.now() / 1000)
                    }),
                    signal: controller.signal // Link abort controller to fetch
                });
                clearTimeout(timeoutId); // Clear timeout if fetch completes
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                const result = data?.data?.list || [];
                apiCache.set(cacheKey, { data: result, timestamp: Date.now() }); // Cache the fetched page
                return result;
            } catch (error) {
                console.error(`Error fetching page ${page}:`, error);
                return []; // Return empty array on error
            }
        }

        // Determines 'BIG' or 'SMALL' based on a number (0-4 is SMALL, 5-9 is BIG)
        function getBigSmallFromNumber(number) {
            const num = parseInt(number, 10);
            if (isNaN(num)) return null;
            return num >= 0 && num <= 4 ? 'SMALL' : num >= 5 && num <= 9 ? 'BIG' : null;
        }

        // Generates a "quantum prediction" based on recent historical data
        async function generateQuantumPrediction(historyData) {
            // Get the last 20 results and convert them to 'BIG' or 'SMALL'
            const recentResults = historyData.slice(0, 20).map(item => getBigSmallFromNumber(item.number)).filter(Boolean); 

            let bigCount = 0;
            let smallCount = 0;
            recentResults.forEach(result => {
                if (result === 'BIG') bigCount++;
                else smallCount++;
            });

            let prediction = 'BIG'; // Default prediction
            let probability = 50; // Base probability

            // Logic to determine prediction based on frequency and recent patterns
            if (bigCount > smallCount + 3) { // If 'BIG' is significantly more frequent
                prediction = 'SMALL'; // Predict the opposite
                probability = 60 + (bigCount - smallCount); // Higher confidence
            } else if (smallCount > bigCount + 3) { // If 'SMALL' is significantly more frequent
                prediction = 'BIG'; // Predict the opposite
                probability = 60 + (smallCount - bigCount); // Higher confidence
            } else {
                // If counts are balanced, look at the last two results for a pattern
                if (recentResults.length >= 2) {
                    if (recentResults[0] === recentResults[1]) { // If last two were the same
                        prediction = (recentResults[0] === 'BIG') ? 'SMALL' : 'BIG'; // Predict the opposite
                        probability = 55;
                    } else { // If last two were different
                        prediction = (recentResults[0] === 'BIG') ? 'SMALL' : 'BIG'; // Predict the opposite of the very last one
                        probability = 52;
                    }
                }
                // If not enough history or no clear pattern, default to random
                else {
                    prediction = Math.random() > 0.5 ? 'BIG' : 'SMALL';
                    probability = 50;
                }
            }

            // Cap probability between 50% and 90%
            probability = Math.min(90, Math.max(50, probability));

            return {
                result: prediction,
                probability: probability
            };
        }

        // Updates the server status indicator and text
        function updateServerStatus(isConnected) {
            const statusElement = document.getElementById('serverStatus');
            const indicator = document.getElementById('serverStatusIndicator');
            if (statusElement && indicator) { 
                if (isConnected) {
                    statusElement.textContent = translations[currentLanguage].connected;
                    indicator.classList.add('animate-ping', 'bg-4682B4');
                    indicator.classList.remove('bg-gray-500');
                } else {
                    statusElement.textContent = translations[currentLanguage].disconnected;
                    indicator.classList.remove('animate-ping', 'bg-4682B4');
                    indicator.classList.add('bg-gray-500');
                }
            }
        }

        // Updates the main prediction display area (period, result, confidence)
        function updatePredictionDisplay() {
            const currentPeriodEl = document.getElementById('currentPeriod');
            const currentResultEl = document.getElementById('currentResult');
            const confidenceFillEl = document.getElementById('confidenceFill');
            const confidenceTextEl = document.getElementById('confidenceText');

            // Check if all necessary elements exist before attempting to update
            if (!currentPeriodEl || !currentResultEl || !confidenceFillEl || !confidenceTextEl) {
                console.warn("Prediction display elements not found. Skipping update.");
                return;
            }

            if (state.currentPrediction) {
                // Display the current prediction if available
                currentPeriodEl.textContent = state.lastPeriodNumber.slice(-5); // Show last 5 digits of period
                currentResultEl.textContent = `${state.currentPrediction.result}`;
                confidenceFillEl.style.width = `${state.currentPrediction.probability}%`;
                confidenceTextEl.textContent = `${state.currentPrediction.probability}%`;
            } else {
                // Show loading state if no prediction yet
                currentPeriodEl.textContent = state.lastPeriodNumber ? state.lastPeriodNumber.slice(-5) : '-';
                currentResultEl.innerHTML = `
                    <div class="loader">
                        <div class="loader-hourglass"></div>
                        <div class="loader-text">Generating Prediction...</div>
                    </div>`;
                confidenceFillEl.style.width = '0%';
                confidenceTextEl.textContent = '0%';
            }
        }

        // Generates a new prediction and updates the state and UI
        async function generateResult(period) {
            // Prevent multiple simultaneous prediction generations for the same period
            if (state.isResultProcessing || (state.currentPrediction && state.currentPeriod === period)) {
                return;
            }
            state.isResultProcessing = true; // Set processing flag

            updatePredictionDisplay(); // Show loading state immediately

            try {
                const historicalData = await fetchOptimizedData(); // Fetch historical data
                const startTime = performance.now();
                const prediction = await generateQuantumPrediction(historicalData); // Generate prediction
                const elapsed = performance.now() - startTime;
                const delay = Math.max(0, 1500 - elapsed); // Ensure a minimum display time for loader
                await new Promise(resolve => setTimeout(resolve, delay)); // Wait for minimum display time

                state.currentResult = prediction.result;
                state.currentPrediction = { result: prediction.result, probability: prediction.probability };
                state.currentPeriod = period;

                // Add new prediction to history
                const historyEntry = {
                    period: period.slice(-5),
                    prediction: prediction.result,
                    probability: prediction.probability,
                    status: "predicted" // Mark as predicted
                };
                state.history.unshift(historyEntry); // Add to the beginning of history
                state.lastResults.bigsmall.unshift(prediction.result); // Add to last 5 results
                if (state.lastResults.bigsmall.length > 5) state.lastResults.bigsmall.pop(); // Keep only last 5

                updatePredictionDisplay(); // Update display with new prediction
                updateHistory(); // Refresh history section
                updateStats(); // Refresh statistics
                updateAnalysisDashboard(); // Refresh analysis dashboard

                // Send desktop notification if enabled and permission granted
                if (isNotificationsEnabled && Notification.permission === 'granted') {
                    new Notification(`New Prediction: ${prediction.result}`, {
                        body: `Period: ${period.slice(-5)}\nConfidence: ${prediction.probability}%`,
                        icon: 'https://via.placeholder.com/32' // Placeholder icon
                    });
                }
            } catch (error) {
                console.error("Error in generateResult:", error);
                // Display error message if prediction fails
                document.getElementById('currentResult').textContent = 'PREDICTION ERROR';
                document.getElementById('confidenceFill').style.width = '0%';
                document.getElementById('confidenceText').textContent = '0%';
                updateServerStatus(false); // Indicate server disconnection on error
            } finally {
                state.isResultProcessing = false; // Reset processing flag
            }
        }

        // Renders and updates the history section based on the 'state.history' array
        function updateHistory() {
            const historyContainer = document.getElementById('history');
            if (!historyContainer) return;

            historyContainer.innerHTML = ''; // Clear existing history items
            const recentHistory = state.history.slice(0, 10); // Display only the most recent 10 items
            recentHistory.forEach((entry, index) => {
                const status = entry.status.toLowerCase();
                const iconClass = {
                    predicted: 'fas fa-check-circle predicted-icon',
                    pending: 'fas fa-hourglass-half pending-icon'
                }[status] || 'fas fa-question-circle'; // Default icon
                const badgeClass = {
                    predicted: 'predicted-badge',
                    pending: 'pending-badge'
                }[status] || ''; // Default badge class

                const historyItem = document.createElement('div');
                historyItem.className = `history-item ${status} flex items-center justify-between p-4 rounded-xl`;
                historyItem.innerHTML = `
                    <div class="watermark">QUINTUS ULTRA</div>
                    <div class="flex items-center space-x-3">
                        <div class="status-icon ${badgeClass}">
                            <i class="${iconClass}"></i>
                        </div>
                        <div>
                            <p class="text-lg font-semibold">Period: ${entry.period}</p>
                            <p class="text-sm">Predicted: ${entry.prediction}</p>
                            ${entry.probability ? `<p class="text-sm">Confidence: ${entry.probability}%</p>` : ''}
                        </div>
                    </div>
                    <button class="delete-btn hover:text-4682B4 transition" data-index="${index}">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                historyContainer.appendChild(historyItem);
                // Add event listener for the delete button on each history item
                historyItem.querySelector('.delete-btn').addEventListener('click', () => {
                    showConfirmModal(translations[currentLanguage].delete_item_confirm, () => {
                        state.history.splice(index, 1); // Remove item from history array
                        updateHistory(); // Re-render history
                    });
                });
            });
        }

        // Updates the statistics section (wins, losses, win rate, streak, last 5 results)
        function updateStats() {
            // NOTE: The current implementation sets wins, losses, winRate, and streak to static values or 'N/A'.
            // To make these truly dynamic, you would need to implement logic to track actual wins/losses
            // based on comparing predictions with actual results from the API.
            const wins = 0; 
            const losses = 0;
            const total = wins + losses;
            const winRate = total > 0 ? ((wins / total) * 100).toFixed(2) : 0;
            const streak = 'N/A'; // Placeholder for streak calculation
            const lastFive = state.lastResults.bigsmall.slice(0, 5).join(', ') || '-'; // Display last 5 big/small results

            // Update DOM elements with calculated statistics
            if (document.getElementById('winRate')) document.getElementById('winRate').textContent = `${winRate}%`;
            if (document.getElementById('totalWinBets')) document.getElementById('totalWinBets').textContent = wins;
            if (document.getElementById('totalLossBets')) document.getElementById('totalLossBets').textContent = losses;
            if (document.getElementById('statsTotalWins')) document.getElementById('statsTotalWins').textContent = wins;
            if (document.getElementById('statsTotalLosses')) document.getElementById('statsTotalLosses').textContent = losses;
            if (document.getElementById('statsWinRate')) document.getElementById('statsWinRate').textContent = `${winRate}%`;
            if (document.getElementById('currentStreak')) document.getElementById('currentStreak').textContent = streak;
            if (document.getElementById('lastFiveResults')) document.getElementById('lastFiveResults').textContent = lastFive;
        }

        // Updates the analysis dashboard with most/least frequent numbers
        async function updateAnalysisDashboard() {
            const data = await fetchOptimizedData(); // Fetch data for analysis
            // Extract the last digit of numbers from the data
            const numbers = data.length ? data.map(item => parseInt(item.number, 10) % 10) : [];
            let mostFrequent = '-';
            let leastFrequent = '-';
            if (numbers.length > 0) {
                // Calculate frequency of each number
                const freq = numbers.reduce((acc, n) => {
                    acc[n] = (acc[n] || 0) + 1;
                    return acc;
                }, {});
                // Sort numbers by frequency
                const sorted = Object.entries(freq).sort((a, b) => b[1] - a[1]);
                mostFrequent = sorted[0]?.[0] || '-'; // Most frequent is the first element
                leastFrequent = sorted[sorted.length - 1]?.[0] || '-'; // Least frequent is the last element
            }
            // Update DOM elements
            if (document.getElementById('mostFrequent')) document.getElementById('mostFrequent').textContent = mostFrequent;
            if (document.getElementById('leastFrequent')) document.getElementById('leastFrequent').textContent = leastFrequent;
        }

        // Event listener for the "Delete All History" button
        document.getElementById('deleteAllHistoryBtn').addEventListener('click', () => {
            showConfirmModal(translations[currentLanguage].delete_all_confirm, () => {
                // Reset all history and stats related to history
                state.history = [];
                state.stats.totalWins = 0;
                state.stats.totalLosses = 0;
                state.stats.winCount = 0;
                state.stats.lossStreak = 0;
                state.stats.totalBets = 0;
                state.lastResults.bigsmall = [];
                updateHistory(); // Re-render history (now empty)
                updateStats(); // Update stats (now reset)
                if (isSoundEnabled) {
                    new Audio('https://www.soundjay.com/buttons/beep-01a.mp3').play();
                }
            });
        });

        // --- Period Timer with API-based Syncing ---
        let isFetchingPeriod = false; // Flag to prevent concurrent fetches
        const PERIOD_FETCH_INTERVAL = 3000; // Fetch every 3 seconds
        let lastPeriodFetchTime = 0; // Timestamp of the last period fetch

        // Function to continuously update the period and trigger new predictions
        async function updatePeriodAndTimer() {
            const now = Date.now();
            // Throttle the API call to avoid excessive requests and only fetch if not already fetching
            if (now - lastPeriodFetchTime > PERIOD_FETCH_INTERVAL && !isFetchingPeriod) {
                isFetchingPeriod = true; // Set flag
                lastPeriodFetchTime = now; // Update last fetch time
                try {
                    // Fetch only the most recent results to find the last completed period
                    const data = await fetchOptimizedPage(1); 
                    if (data && data.length > 0) {
                        // The first item in the list is typically the most recent completed period
                        const lastCompletedPeriod = data[0].issue;
                        
                        // Safely increment the period number using BigInt for large numbers
                        const lastPeriodNum = BigInt(lastCompletedPeriod);
                        const currentPeriod = (lastPeriodNum + 1n).toString();

                        // If the period has changed, it's time for a new prediction
                        if (state.lastPeriodNumber !== currentPeriod) {
                            console.log(`New period detected. Old: ${state.lastPeriodNumber}, New: ${currentPeriod}`);
                            state.lastPeriodNumber = currentPeriod; // Update last known period
                            state.currentPrediction = null; // Reset prediction for the new period
                            state.currentPeriod = currentPeriod; // Set current period for prediction
                            await generateResult(currentPeriod); // Generate a new prediction
                        }
                    }
                } catch (error) {
                    console.error("Error fetching latest period:", error);
                    updateServerStatus(false); // Indicate server disconnection on error
                } finally {
                    isFetchingPeriod = false; // Reset fetching flag
                }
            }
            
            // Keep the loop running for continuous updates using requestAnimationFrame
            requestAnimationFrame(updatePeriodAndTimer);
        }

        // Request notification permission if not already granted or denied
        if (isNotificationsEnabled && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // Initializes the main application components and starts data fetching/updates
        function initializeApp() {
            updateLanguage(); // Set initial language
            updateServerStatus(true); // Assume connected initially
            updatePeriodAndTimer(); // Start the period timer and prediction loop
            updateStats(); // Update initial statistics
            updateAnalysisDashboard(); // Update initial analysis dashboard
        }

        // Clean up on page unload (though requestAnimationFrame typically stops)
        window.addEventListener('beforeunload', () => {
            // No specific cleanup needed for requestAnimationFrame as it stops automatically.
            // This is more for potential other resources if they were added.
        });
    </script>
</body>
</html>
